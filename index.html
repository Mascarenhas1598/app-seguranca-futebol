<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Seguran√ßa em Eventos - NM Engenharia</title>
  
  <!-- Depend√™ncias -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .risk-indicator { transition: all 0.3s ease; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
  <!-- Tela de Login -->
  <div id="login-screen" class="max-w-md mx-auto pt-20 px-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 transition-all">
      <form id="loginForm" class="space-y-6">
        <img src="/images/logo_nm_engenharia.jpg" 
             alt="NM Engenharia" 
             class="w-40 h-40 mx-auto mb-8 object-contain"
             onerror="this.onerror=null;this.src='/images/placeholder-logo.png';this.classList.add('border', 'p-2')">
        
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300 required-field">Usu√°rio</label>
          <input type="text" required class="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 transition-all">
        </div>

        <div class="relative">
          <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300 required-field">Senha</label>
          <input type="password" required class="w-full px-4 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 transition-all">
          <button type="button" class="absolute right-3 bottom-2.5 text-gray-500 dark:text-gray-400 hover:text-blue-600 transition-colors" onclick="togglePasswordVisibility(this)">üëÅÔ∏è</button>
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-5 rounded-lg transition-colors duration-200">Acessar Sistema</button>
      </form>
    </div>
  </div>

  <!-- Interface Principal -->
  <div id="main-interface" class="hidden max-w-6xl mx-auto p-6 space-y-10">
    <header class="flex items-center justify-between mb-6">
      <img src="/images/logo_nm_engenharia.jpg" alt="NM Engenharia" class="w-40 h-40 object-contain" onerror="this.style.display='none'">
      <button onclick="toggleTheme()" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">üåì Tema</button>
    </header>

    <!-- Ajuda Geral -->
    <section class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 p-4 rounded">
      <h2 class="text-lg font-bold mb-2 text-yellow-800 dark:text-yellow-200">Ajuda Geral</h2>
      <ul class="list-disc list-inside text-sm text-yellow-700 dark:text-yellow-300">
        <li>Preencha os campos obrigat√≥rios de forma clara e objetiva</li>
        <li>Utilize valores entre 0 e 1 conforme a legenda</li>
        <li>Registre apenas ocorr√™ncias reais com dados verificados</li>
        <li>Use a previs√£o de risco com IA como suporte √† decis√£o</li>
      </ul>
    </section>

    <!-- Cadastro de Partida -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4 dark:text-white">Cadastro da Partida</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold dark:text-gray-300">Data</label>
          <input type="date" id="dataEvento" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div>
          <label class="block font-semibold dark:text-gray-300">Hor√°rio</label>
          <input type="time" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div class="md:col-span-2">
          <label class="block font-semibold dark:text-gray-300">Equipes Envolvidas</label>
          <input type="text" id="equipesEnvolvidas" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div>
          <label class="block font-semibold dark:text-gray-300">Local do Evento</label>
          <input type="text" id="localEvento" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div>
          <label class="block font-semibold dark:text-gray-300">Capacidade do Local</label>
          <input type="number" id="capacidadeLocal" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        </div>
      </div>
    </section>

    <!-- An√°lise de Risco -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded shadow">
      <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-400 text-sm">
        <p class="font-bold dark:text-blue-200">Legenda dos Campos "0 a 1":</p>
        <ul class="list-disc list-inside dark:text-blue-300">
          <li><strong>0</strong> = Condi√ß√£o ideal</li>
          <li><strong>0.5</strong> = Risco moderado</li>
          <li><strong>1</strong> = Alto risco</li>
        </ul>
      </div>
      
      <h2 class="text-xl font-bold mb-4 dark:text-white">An√°lise de Risco</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Lista de campos de entrada mantida -->
        <div>
          <label class="block font-semibold dark:text-gray-300">Expectativa de P√∫blico</label>
          <input type="number" id="fatorPublico" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
        </div>
        <!-- Demais campos mantidos conforme c√≥digo original -->
      </div>
      
      <button onclick="preverRiscoIA()" class="mt-6 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded dark:bg-green-700 dark:hover:bg-green-800">Prever Risco com IA</button>
      <p id="resultadoIA" class="mt-4 font-bold dark:text-white"></p>
    </section>

    <!-- Impacto Visual do Risco -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4 dark:text-white">Impacto Visual do Risco</h2>
      <canvas id="graficoImpacto" height="120"></canvas>
    </section>

    <!-- Relat√≥rio Fotogr√°fico -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4 dark:text-white">Relat√≥rio Fotogr√°fico</h2>
      <div class="mb-4 p-4 bg-green-50 dark:bg-green-900 border-l-4 border-green-400 text-sm">
        <p class="dark:text-green-200"><strong>Instru√ß√µes:</strong> Envie at√© 5 fotos por fase do evento</p>
      </div>
      <div id="fasesContainer" class="space-y-8">
        <!-- Fases mantidas conforme c√≥digo original -->
      </div>
    </section>

    <!-- Exportar Relat√≥rio -->
    <section class="bg-white dark:bg-gray-800 p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4 dark:text-white">Exportar Relat√≥rio</h2>
      <button id="exportarPDF" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded dark:bg-blue-700 dark:hover:bg-blue-800">Exportar para PDF</button>
      <div id="loadingPDF" class="hidden mt-4 text-blue-600 dark:text-blue-400">Gerando PDF...</div>
    </section>
  </div>

  <script>
    // Classe RiskAnalyzer atualizada
    class RiskAnalyzer {
      constructor() {
        this.model = null;
        this.trainingData = [];
        this.initModel();
      }

      async initModel() {
        try {
          this.model = await tf.loadLayersModel('indexeddb://risk-model');
        } catch {
          this.model = this.createNewModel();
        }
      }

      createNewModel() {
        const model = tf.sequential({
          layers: [
            tf.layers.dense({ units: 8, inputShape: [18], activation: 'relu' }),
            tf.layers.dense({ units: 4, activation: 'relu' }),
            tf.layers.dense({ units: 1, activation: 'sigmoid' })
          ]
        });

        model.compile({
          optimizer: tf.train.adam(0.01),
          loss: 'meanSquaredError',
          metrics: ['accuracy']
        });

        return model;
      }

      async calculateRisk(factors) {
        const tensor = this.prepareInputTensor(factors);
        const prediction = this.model.predict(tensor);
        const risk = (await prediction.data())[0] * 100;
        tf.dispose([tensor, prediction]);
        return risk;
      }

      prepareInputTensor(factors) {
        return tf.tensor2d([[
          factors.publico / 50000,
          factors.treinamento,
          factors.inspecao,
          factors.checkpoints,
          factors.vias,
          factors.iluminacao,
          factors.apoioPolicial,
          factors.diaSemana,
          factors.historico,
          factors.monitoramento,
          factors.mandados,
          factors.efetivo / 100,
          factors.ocorrencias / 50,
          factors.clima,
          factors.rivalidade,
          factors.visitante,
          factors.infraestrutura,
          factors.evacuacao
        ]]);
      }
    }

    const riskAnalyzer = new RiskAnalyzer();
    let impactoChart = null;

    // Fun√ß√µes de Interface
    function toggleTheme() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('themePreference', isDark ? 'light' : 'dark');
    }

    function togglePasswordVisibility(button) {
      const input = button.previousElementSibling;
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    // Fun√ß√£o de Previs√£o de Risco Integrada
    async function preverRiscoIA() {
      const fatores = {
        publico: parseFloat(document.getElementById('fatorPublico').value) || 0,
        treinamento: parseFloat(document.getElementById('treinamentoSeguranca').value) || 0.5,
        inspecao: parseFloat(document.getElementById('tempoInspecao').value) || 0.5,
        checkpoints: parseFloat(document.getElementById('eficienciaCheckpoints').value) || 0.5,
        vias: parseFloat(document.getElementById('condicaoVias').value) || 0.5,
        iluminacao: parseFloat(document.getElementById('iluminacaoPublica').value) || 0.5,
        apoioPolicial: parseFloat(document.getElementById('distanciaApoioPolicial').value) || 0.5,
        diaSemana: parseFloat(document.getElementById('diaSemana').value) || 0,
        historico: parseFloat(document.getElementById('historicoEmocional').value) || 0.5,
        monitoramento: parseFloat(document.getElementById('monitoramentoGrupos').value) || 0.5,
        mandados: parseFloat(document.getElementById('mandadosPendentes').value) || 0,
        efetivo: parseFloat(document.getElementById('fatorEfetivo').value) || 0,
        ocorrencias: parseFloat(document.getElementById('fatorOcorrencias').value) || 0,
        clima: parseFloat(document.getElementById('clima').value) || 0.5,
        rivalidade: parseFloat(document.getElementById('rivalidade').value) || 0.5,
        visitante: parseFloat(document.getElementById('visitante').value) || 0.5,
        infraestrutura: parseFloat(document.getElementById('infraestrutura').value) || 0.5,
        evacuacao: parseFloat(document.getElementById('evacuacao').value) || 0.5
      };

      try {
        const risk = await riskAnalyzer.calculateRisk(fatores);
        const resultadoElement = document.getElementById('resultadoIA');
        
        resultadoElement.innerHTML = `
          <span class="text-${risk > 70 ? 'red' : risk > 40 ? 'orange' : 'green'}-600 dark:text-${risk > 70 ? 'red' : risk > 40 ? 'orange' : 'green'}-400">
            Risco calculado: ${risk.toFixed(1)}% (${risk > 70 ? 'ALTO' : risk > 40 ? 'MODERADO' : 'BAIXO'})
          </span>
        `;

        desenharGraficoImpacto(risk);
      } catch (error) {
        console.error("Erro na an√°lise:", error);
        alert("Erro na an√°lise. Verifique os dados.");
      }
    }

    // Fun√ß√µes de Relat√≥rio (mantidas do c√≥digo original)
    // ... [As fun√ß√µes de gera√ß√£o de PDF e manipula√ß√£o de fotos permanecem inalteradas]

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('themePreference') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);

      document.getElementById("loginForm").addEventListener("submit", function(e) {
        e.preventDefault();
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("main-interface").classList.remove("hidden");
      });

      document.getElementById("exportarPDF").addEventListener("click", gerarRelatorioPDF);
    });
  </script>
</body>
</html>
