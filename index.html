<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- Adição de SRI completo e remoção de chaves expostas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" 
    integrity="sha384-8iWazJoi4j+LYC9HB2D6pTG0/ORCj+29f+QJhU6zpYp02EI0QuN1J3qX9Tp8mYy" 
    crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com/3.4.1"
    integrity="sha384-O8n0Q8rihkZl7pwR5ZHSoyqLovDIAnp8E4p9S7F5Cp8vY2fAhO8eYJjYJHPBdI7"
    crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- Login - Formulário corrigido -->
  <div id="login" class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-md">
    <form id="loginForm">
      <input type="hidden" id="csrfToken" name="_csrf" value="{{csrfToken}}"> <!-- Token gerado pelo servidor -->
      <!-- ... resto do formulário ... -->
    </form>
  </div>

  <!-- App Principal - Seções revisadas -->
  <div id="app" class="hidden max-w-6xl mx-auto p-6 space-y-10">
    <!-- ... conteúdo mantido com melhorias de segurança ... -->
  </div>

  <script>
    // Classe RiskAnalyzer corrigida
    class RiskAnalyzer {
      constructor() {
        this.model = null;
        this.trainingData = [];
        this.initModel();
      }

      async fetchGoogleData(factors) {
        try {
          const response = await fetch('/api/google-search', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
              query: `${factors.equipesEnvolvidas} ${factors.localEvento} segurança`
            })
          });
          // ... tratamento da resposta ...
        } catch (error) {
          console.error("Erro na API:", error);
          updateAPIStatus('Erro na conexão', 'red');
        }
      }
    }

    // Autenticação melhorada
    async function handleLogin(event) {
      event.preventDefault();
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.getElementById('csrfToken').value
          },
          body: JSON.stringify({
            username: document.getElementById('usuario').value,
            password: hashPassword(document.getElementById('senha').value) // Hash cliente
          })
        });

        if (response.ok) {
          const data = await response.json();
          sessionStorage.setItem('authToken', data.token);
          document.getElementById('login').classList.add('hidden');
          document.getElementById('app').classList.remove('hidden');
        } else {
          mostrarNotificacao("Falha na autenticação", "erro");
        }
      } catch (error) {
        console.error("Erro:", error);
        mostrarNotificacao("Erro de conexão", "erro");
      }
    }

    // Validação de campos aprimorada
    function validarCamposObrigatorios() {
      let isValid = true;
      document.querySelectorAll('[required]').forEach(input => {
        if (!input.value || (input.type === 'number' && (isNaN(input.value) || input.value < 0 || input.value > 1))) {
          input.classList.add('shake', 'border-red-500');
          isValid = false;
          setTimeout(() => input.classList.remove('shake', 'border-red-500'), 1000);
        }
      });
      return isValid;
    }

    // Gerenciamento de token
    function getAuthToken() {
      const token = sessionStorage.getItem('authToken');
      if (!token) window.location.href = '/login';
      return token;
    }

    // Inicialização segura
    document.addEventListener('DOMContentLoaded', () => {
      // Forçar HTTPS
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        location.replace(`https://${location.host}${location.pathname}`);
      }

      // Event listeners
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    });

    // Funções auxiliares
    function hashPassword(password) {
      // Implementar hash seguro (ex: bcrypt via Web Crypto API)
      return password; // Apenas exemplo - substituir por implementação real
    }

    function mostrarNotificacao(mensagem, tipo) {
      // Implementar lógica de notificação
      console.log(`${tipo}: ${mensagem}`);
    }
  </script>
</body>
</html>
