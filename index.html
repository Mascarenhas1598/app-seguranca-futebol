<!-- Adicione no <head> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Substitua a seção "Exportar Relatório" por: -->
<section class="bg-white p-6 rounded shadow">
  <h2 class="text-xl font-bold mb-4">Exportar Relatório</h2>
  <button onclick="gerarRelatorioPDF()" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
    Exportar para PDF
  </button>
</section>

<!-- Novo script -->
<script>
  // Configuração do PDF
  function gerarRelatorioPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4"
    });

    // Dados dinâmicos
    const dataEvento = document.querySelector("input[type='date']").value;
    const equipes = document.getElementById("equipesEnvolvidas").value;
    const riscoIA = document.getElementById("resultadoIA").innerText;

    // ---- CAPA ----
    doc.setFontSize(22);
    doc.setTextColor(40, 40, 40);
    doc.text("RELATÓRIO DE SEGURANÇA EM EVENTOS", 105, 40, { align: "center" });
    
    doc.setFontSize(16);
    doc.text(`Partida: ${equipes}`, 105, 60, { align: "center" });
    doc.text(`Data: ${formatarData(dataEvento)}`, 105, 70, { align: "center" });
    
    doc.addPage();

    // ---- DADOS DA PARTIDA ----
    doc.setFontSize(18);
    doc.setTextColor(30, 58, 138);
    doc.text("1. DADOS DA PARTIDA", 20, 30);
    
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`• Equipes: ${equipes}`, 20, 40);
    doc.text(`• Data: ${formatarData(dataEvento)}`, 20, 45);
    // Adicione mais campos conforme necessário...

    // ---- ANÁLISE DE RISCO ----
    doc.setFontSize(18);
    doc.setTextColor(30, 58, 138);
    doc.text("2. ANÁLISE DE RISCO", 20, 60);
    
    doc.setFontSize(12);
    doc.text(riscoIA.split('\n')[0], 20, 70);
    
    // Gráfico (converte canvas para imagem)
    const canvas = document.getElementById("graficoImpacto");
    if (canvas) {
      const canvasImg = await html2canvas(canvas);
      doc.addImage(canvasImg, 'JPEG', 20, 80, 150, 80);
    }

    doc.addPage();

    // ---- RELATÓRIO FOTOGRÁFICO ----
    doc.setFontSize(18);
    doc.setTextColor(30, 58, 138);
    doc.text("3. RELATÓRIO FOTOGRÁFICO", 20, 30);
    
    let yPos = 40;
    for (const [fase, fotos] of Object.entries(fotosPorFase)) {
      if (fotos.length > 0) {
        doc.setFontSize(14);
        doc.text(`Fase: ${fase}`, 20, yPos);
        yPos += 10;
        
        for (let i = 0; i < fotos.length; i++) {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
          
          const imgData = await getBase64(fotos[i]);
          doc.addImage(imgData, 'JPEG', 20, yPos, 40, 30);
          doc.text(`Foto ${i+1}: ${fotos[i].name}`, 65, yPos + 15);
          yPos += 35;
        }
      }
    }

    // Salvar PDF
    doc.save(`Relatorio_Seguranca_${equipes.replace(/ x /, "_vs_")}_${dataEvento}.pdf`);
  }

  // Funções auxiliares
  function formatarData(dataISO) {
    if (!dataISO) return "Não informada";
    const [ano, mes, dia] = dataISO.split("-");
    return `${dia}/${mes}/${ano}`;
  }

  function getBase64(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
    });
  }
</script>
