<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Segurança em Eventos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bibliotecas para geração de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- Login -->
  <div id="login" class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-md">
    <img src="./logo_nm_engenharia.jpg" alt="Logo NM Engenharia" class="mx-auto mb-6 w-40">
    <h2 class="text-2xl font-bold text-center mb-4">Acesso Restrito</h2>
    <label for="usuario" class="block font-semibold">Usuário</label>
    <input type="text" id="usuario" class="w-full p-2 border border-gray-300 rounded mb-4">
    <label for="senha" class="block font-semibold">Senha</label>
    <input type="password" id="senha" class="w-full p-2 border border-gray-300 rounded mb-6">
    <button id="entrar" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 w-full">Entrar</button>
  </div>

  <!-- App Principal (oculto inicialmente) -->
  <div id="app" class="hidden max-w-6xl mx-auto p-6 space-y-10">
    <img src="./logo_nm_engenharia.jpg" alt="Logo NM Engenharia" class="mx-auto mb-6 w-40">
    
    <!-- Ajuda Geral -->
    <section class="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded">
      <h2 class="text-lg font-bold mb-2 text-yellow-800">Ajuda Geral</h2>
      <ul class="list-disc list-inside text-sm text-yellow-700">
        <li>Preencha os campos obrigatórios de forma clara e objetiva.</li>
        <li>Utilize os valores entre 0 e 1 nas análises conforme a legenda apresentada.</li>
        <li>Faça o upload de fotos com descrição detalhada em cada fase do evento.</li>
        <li>Registre apenas ocorrências reais, com dados verificados.</li>
        <li>Use a previsão de risco com IA como suporte à tomada de decisão.</li>
        <li>Ao final, utilize a função de exportar para gerar seu relatório em PDF.</li>
      </ul>
    </section>

    <!-- Cadastro de Partida -->
    <section class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Cadastro da Partida</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block font-semibold">Data</label>
          <input type="date" id="dataEvento" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block font-semibold">Horário</label>
          <input type="time" class="w-full p-2 border rounded">
        </div>
        <div class="md:col-span-2">
          <label class="block font-semibold">Equipes Envolvidas</label>
          <input type="text" id="equipesEnvolvidas" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block font-semibold">Local de Interesse</label>
          <input type="text" id="localEvento" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block font-semibold">Capacidade Habilitada do Local</label>
          <input type="number" id="capacidadeLocal" class="w-full p-2 border rounded">
        </div>
      </div>
    </section>

    <!-- Análise de Risco -->
    <section class="bg-white p-6 rounded shadow">
      <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 text-sm text-blue-700">
        <p><strong>Legenda dos Campos "0 a 1":</strong></p>
        <ul class="list-disc list-inside">
          <li><strong>0</strong> = Condição ideal ou risco nulo</li>
          <li><strong>0.5</strong> = Situação intermediária ou risco moderado</li>
          <li><strong>1</strong> = Condição crítica ou alto risco</li>
        </ul>
      </div>
      <h2 class="text-xl font-bold mb-4">Análise de Risco</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="block font-semibold">Expectativa de Público</label>
          <input type="number" id="fatorPublico" class="w-full p-2 border rounded" placeholder="Ex: 10000">
        </div>
        <div>
          <label class="block font-semibold">Nível de Treinamento da Equipe de Segurança</label>
          <input type="number" id="treinamentoSeguranca" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Tempo de Inspeção Prévia do Estádio</label>
          <input type="number" id="tempoInspecao" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Eficiência dos Checkpoints</label>
          <input type="number" id="eficienciaCheckpoints" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Condição das Vias de Acesso</label>
          <input type="number" id="condicaoVias" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Iluminação Pública no Entorno</label>
          <input type="number" id="iluminacaoPublica" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Distância até Apoio Policial</label>
          <input type="number" id="distanciaApoioPolicial" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Dia da Semana (0=Segunda, 1=Domingo ou feriado)</label>
          <input type="number" id="diaSemana" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Histórico Emocional do Confronto</label>
          <input type="number" id="historicoEmocional" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Monitoramento de Grupos Organizados</label>
          <input type="number" id="monitoramentoGrupos" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Mandados de Prisão Pendentes</label>
          <input type="number" id="mandadosPendentes" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Efetivo Empregado (1 segurança a cada 100 pessoas)</label>
          <input type="number" id="fatorEfetivo" class="w-full p-2 border rounded" placeholder="Ex: 50">
        </div>
        <div>
          <label class="block font-semibold">Número de Ocorrências</label>
          <input type="number" id="fatorOcorrencias" class="w-full p-2 border rounded">
        </div>
        <div>
          <label class="block font-semibold">Clima</label>
          <input type="number" id="clima" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Rivalidade</label>
          <input type="number" id="rivalidade" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Torcida Visitante</label>
          <input type="number" id="visitante" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Infraestrutura</label>
          <input type="number" id="infraestrutura" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
        <div>
          <label class="block font-semibold">Evacuação</label>
          <input type="number" id="evacuacao" class="w-full p-2 border rounded" placeholder="0 a 1">
        </div>
      </div>
      <button onclick="preverRiscoIA()" class="mt-6 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">Prever Risco com IA</button>
      <p id="resultadoIA" class="mt-4 font-bold"></p>
    </section>

    <!-- Impacto Visual do Risco -->
    <section class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Impacto Visual do Risco</h2>
      <canvas id="graficoImpacto" height="120"></canvas>
    </section>

    <!-- Relatório Fotográfico (versión detallada única) -->
    <section class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Relatório Fotográfico</h2>
      <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-400 text-sm text-green-700">
        <p><strong>Instruções:</strong> Envie até 5 fotos por fase do evento. Cada imagem deve ter uma descrição clara do que está sendo registrado.</p>
      </div>
      <div id="fasesContainer" class="space-y-8">
        <div class="fase-fotografica" data-fase="Montagem">
          <h3 class="text-lg font-semibold mb-2">Montagem</h3>
          <input type="file" accept="image/*" multiple onchange="atualizarFotos(this, 'Montagem')" class="w-full p-2 border rounded">
          <div id="previewMontagem" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2"></div>
        </div>
        <div class="fase-fotografica" data-fase="Entrada">
          <h3 class="text-lg font-semibold mb-2">Entrada</h3>
          <input type="file" accept="image/*" multiple onchange="atualizarFotos(this, 'Entrada')" class="w-full p-2 border rounded">
          <div id="previewEntrada" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2"></div>
        </div>
        <div class="fase-fotografica" data-fase="Jogo">
          <h3 class="text-lg font-semibold mb-2">Jogo</h3>
          <input type="file" accept="image/*" multiple onchange="atualizarFotos(this, 'Jogo')" class="w-full p-2 border rounded">
          <div id="previewJogo" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2"></div>
        </div>
        <div class="fase-fotografica" data-fase="Evacuação">
          <h3 class="text-lg font-semibold mb-2">Evacuação</h3>
          <input type="file" accept="image/*" multiple onchange="atualizarFotos(this, 'Evacuação')" class="w-full p-2 border rounded">
          <div id="previewEvacuação" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2"></div>
        </div>
        <div class="fase-fotografica" data-fase="Fechamento">
          <h3 class="text-lg font-semibold mb-2">Fechamento</h3>
          <input type="file" accept="image/*" multiple onchange="atualizarFotos(this, 'Fechamento')" class="w-full p-2 border rounded">
          <div id="previewFechamento" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2"></div>
        </div>
      </div>
    </section>
    
    <!-- Exportar Relatório -->
    <section class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">Exportar Relatório</h2>
      <button id="exportarPDF" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
        Exportar para PDF
      </button>
      <div id="loadingPDF" class="hidden mt-4 text-blue-600">
        Gerando PDF, por favor aguarde...
      </div>
    </section>
  </div>

  <!-- Scripts -->
  <script>
    // Variáveis globais
    const limiteFotosPorFase = 5;
    const fotosPorFase = {
      Montagem: [],
      Entrada: [],
      Jogo: [],
      Evacuação: [],
      Fechamento: []
    };

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      // Verifica se as bibliotecas estão carregadas
      console.log('jsPDF disponível:', window.jspdf ? 'Sim' : 'Não');
      console.log('html2canvas disponível:', window.html2canvas ? 'Sim' : 'Não');
      
      // Login
      document.getElementById("entrar").addEventListener("click", function() {
        document.getElementById("login").style.display = "none";
        document.getElementById("app").classList.remove("hidden");
      });
      
      // Exportar PDF
      document.getElementById("exportarPDF").addEventListener("click", gerarRelatorioPDF);
    });

    // Funções para manipulação de fotos (mantidas iguais)
    function atualizarFotos(input, fase) {
      // ... (código existente)
    }

    // Função para prever risco (mantida igual)
    function preverRiscoIA() {
      // ... (código existente)
    }

    // Função para desenhar gráfico (mantida igual)
    function desenharGraficoImpacto(estrutural, operacional, comportamental, contextual) {
      // ... (código existente)
    }

    // Funções auxiliares para PDF
    function formatarData(dataISO) {
      if (!dataISO) return "Não informada";
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function getBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Função principal para gerar PDF (totalmente revisada)
    async function gerarRelatorioPDF() {
      const exportBtn = document.getElementById("exportarPDF");
      const loadingIndicator = document.getElementById("loadingPDF");
      
      try {
        // Mostra loading e desabilita botão
        exportBtn.disabled = true;
        loadingIndicator.classList.remove("hidden");
        
        // Verifica bibliotecas
        if (!window.jspdf || !window.html2canvas) {
          throw new Error("Bibliotecas de PDF não carregadas corretamente");
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4"
        });

        // Dados do formulário
        const dataEvento = document.getElementById("dataEvento").value;
        const equipes = document.getElementById("equipesEnvolvidas").value || "Não informado";
        const localEvento = document.getElementById("localEvento").value || "Não informado";
        const capacidade = document.getElementById("capacidadeLocal").value || "Não informada";
        const riscoIA = document.getElementById("resultadoIA")?.innerText || "Análise de risco não realizada";

        // ---- CAPA ----
        doc.setFontSize(22);
        doc.setTextColor(40, 40, 40);
        doc.text("RELATÓRIO DE SEGURANÇA EM EVENTOS", 105, 40, { align: "center" });
        
        // Logo (usando html2canvas para capturar o elemento img)
        try {
          const logo = document.querySelector("#app img[alt='Logo NM Engenharia']");
          if (logo) {
            const canvas = await html2canvas(logo);
            doc.addImage(canvas, 'JPEG', 80, 60, 50, 30);
          }
        } catch (e) {
          console.log("Logo não incluído:", e);
        }
        
        doc.setFontSize(16);
        doc.text(`Partida: ${equipes}`, 105, 120, { align: "center" });
        doc.text(`Data: ${formatarData(dataEvento)}`, 105, 130, { align: "center" });
        
        // ---- DADOS DA PARTIDA ----
        doc.addPage();
        doc.setFontSize(18);
        doc.setTextColor(30, 58, 138);
        doc.text("1. DADOS DA PARTIDA", 20, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`• Equipes: ${equipes}`, 20, 30);
        doc.text(`• Local: ${localEvento}`, 20, 40);
        doc.text(`• Data: ${formatarData(dataEvento)}`, 20, 50);
        doc.text(`• Capacidade: ${capacidade} pessoas`, 20, 60);
        doc.text(`• Horário: ${document.querySelector("input[type='time']").value || "Não informado"}`, 20, 70);

        // ---- ANÁLISE DE RISCO ----
        doc.setFontSize(18);
        doc.setTextColor(30, 58, 138);
        doc.text("2. ANÁLISE DE RISCO", 20, 90);
        
        // Resultado da IA
        doc.setFontSize(12);
        const textoRisco = riscoIA.split('\n')[0]; // Pega apenas a primeira linha
        doc.text(textoRisco, 20, 100, { maxWidth: 170 });
        
        // Gráfico
        const canvas = document.getElementById("graficoImpacto");
        if (canvas) {
          try {
            const canvasImg = await html2canvas(canvas);
            doc.addImage(canvasImg, 'JPEG', 20, 110, 150, 80);
          } catch (e) {
            console.log("Gráfico não incluído:", e);
            doc.text("(Gráfico não pôde ser incluído)", 20, 110);
          }
        }

        // ---- RELATÓRIO FOTOGRÁFICO ----
        doc.addPage();
        doc.setFontSize(18);
        doc.setTextColor(30, 58, 138);
        doc.text("3. RELATÓRIO FOTOGRÁFICO", 20, 20);
        
        let yPos = 30;
        let hasPhotos = false;
        
        for (const [fase, fotos] of Object.entries(fotosPorFase)) {
          if (fotos.length > 0) {
            hasPhotos = true;
            doc.setFontSize(14);
            doc.text(`Fase: ${fase}`, 20, yPos);
            yPos += 10;
            
            for (let i = 0; i < fotos.length; i++) {
              if (yPos > 250) { // Quebra de página
                doc.addPage();
                yPos = 20;
              }
              
              try {
                const imgData = await getBase64(fotos[i]);
                doc.addImage(imgData, 'JPEG', 20, yPos, 40, 30);
                doc.text(`Foto ${i+1}: ${fotos[i].name.substring(0, 30)}`, 65, yPos + 15);
                yPos += 35;
              } catch (e) {
                console.log(`Erro na foto ${i} (${fase}):`, e);
                doc.text(`[Erro ao carregar foto ${i+1}]`, 20, yPos);
                yPos += 10;
              }
            }
          }
        }
        
        if (!hasPhotos) {
          doc.text("Nenhuma foto foi adicionada ao relatório", 20, 30);
        }

        // ---- CONCLUSÃO ----
        doc.addPage();
        doc.setFontSize(18);
        doc.setTextColor(30, 58, 138);
        doc.text("4. CONCLUSÃO", 20, 20);
        
        doc.setFontSize(12);
        doc.text("Relatório gerado automaticamente pelo Sistema de Gestão de Segurança em Eventos.", 20, 30);
        doc.text(`Data de geração: ${new Date().toLocaleString('pt-BR')}`, 20, 40);
        
        // Salva o PDF
        const nomeArquivo = `Relatorio_Seguranca_${equipes.replace(/ x /gi, '_vs_')}_${dataEvento || 'sem_data'}.pdf`;
        doc.save(nomeArquivo);
        
      } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        alert("Erro ao gerar PDF: " + error.message);
      } finally {
        // Restaura botão e esconde loading
        exportBtn.disabled = false;
        loadingIndicator.classList.add("hidden");
      }
    }
  </script>
</body>
</html>
