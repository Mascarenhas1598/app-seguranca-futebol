<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- ... (keep existing head content) ... -->
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

  <!-- Tela de Login -->
  <div id="login" class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-md">
    <img id="logoEmpresa" src="logo_nm_engenharia.jpg" alt="Logo NM Engenharia" 
         class="mx-auto mb-6 w-40 aspect-square object-contain"> <!-- Added object containment -->
    <!-- ... (rest of login form remains same) ... -->
  </div>

  <!-- Aplicativo -->
  <div id="app" class="hidden max-w-6xl mx-auto p-6 space-y-10">
    <!-- ... (existing sections remain same) ... -->
  </div>

  <script>
    // Login handling remains same

    // Photo Gallery Improvements
    let currentChart = null; // To track chart instance

    // Modified risk calculation with validation
    function preverRiscoIA() {
      const publico = parseFloat(document.getElementById('fatorPublico').value) || 0;
      const efetivo = parseFloat(document.getElementById('fatorEfetivo').value) || 0;
      const ocorrencias = parseFloat(document.getElementById('fatorOcorrencias').value) || 0;
      const clima = Math.min(Math.max(parseFloat(document.getElementById('clima').value) || 0, 0), 1);

      // Prevent division by zero
      const publicoSafe = publico > 0 ? publico : 1;
      const risco = (
        (publico / 10000) + 
        ocorrencias + 
        (1 - efetivo / (publicoSafe / 100)) + 
        clima
      ) / 4;

      // ... (existing risk display code)

      // Chart handling with instance management
      const ctx = document.getElementById('graficoImpacto').getContext('2d');
      if(currentChart) currentChart.destroy();
      currentChart = new Chart(ctx, {/*...*/});
    }

    // PDF Export with html2canvas
    async function exportPDF() {
      const appContent = document.getElementById('app');
      const canvas = await html2canvas(appContent);
      const imgData = canvas.toDataURL('image/png');
      
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save('relatorio-seguranca.pdf');
    }

    // Input validation for clima
    document.getElementById('clima').addEventListener('input', function(e) {
      let value = parseFloat(e.target.value);
      if (isNaN(value)) value = 0;
      e.target.value = Math.min(Math.max(value, 0), 1);
    });

    // Initialize with event listeners
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('[onclick="window.print()"]')
              .addEventListener('click', exportPDF);
    });
  </script>
</body>
</html>
